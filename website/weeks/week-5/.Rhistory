library(tidyverse)
library(gridExtra)

# Set theme for plots
theme_set(theme_minimal())

# Configure graphics device for output
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load all CSV files
users <- read_csv("../../../data/soundcloud/output/users.csv")
tracks <- read_csv("../../../data/soundcloud/output/tracks.csv")
follows <- read_csv("../../../data/soundcloud/output/follows.csv")
engagements <- read_csv("../../../data/soundcloud/output/engagements.csv")
streaming_events <- read_csv("../../../data/soundcloud/output/streaming_events.csv")
playlists <- read_csv("../../../data/soundcloud/output/playlists.csv")

# Print separator function for cleaner output
print_section <- function(title) {
  cat("\n", paste(rep("=", 60), collapse=""), "\n")
  cat(title, "\n")
  cat(paste(rep("=", 60), collapse=""), "\n\n")
}

print_section("USERS DATA EXPLORATION")

# Basic info
cat("Dimensions:", dim(users), "\n")
cat("Column names:", paste(names(users), collapse=", "), "\n\n")

# Data summary
summary(users)

# Missing values
cat("\nMissing values:\n")
users %>% 
  summarise_all(~sum(is.na(.))) %>% 
  pivot_longer(everything(), names_to = "column", values_to = "missing") %>% 
  filter(missing > 0)

# User statistics
cat("\nUser Statistics:\n")
users %>% 
  summarise(
    total_users = n(),
    avg_follower_count = mean(follower_count, na.rm = TRUE),
    median_follower_count = median(follower_count, na.rm = TRUE),
    avg_following_count = mean(following_count, na.rm = TRUE),
    median_following_count = median(following_count, na.rm = TRUE),
    avg_track_count = mean(track_count, na.rm = TRUE),
    median_track_count = median(track_count, na.rm = TRUE)
  ) %>% 
  knitr::kable(digits = 2)

# User type distribution
cat("\nUser Type Distribution:\n")
users %>% 
  count(user_type, sort = TRUE) %>% 
  knitr::kable()

users %>% 
  filter(follower_count < quantile(follower_count, 0.99, na.rm = TRUE)) %>% 
  ggplot(aes(x = follower_count)) +
  geom_histogram(fill = "steelblue", bins = 50) +
  scale_x_log10() +
  labs(title = "Distribution of Follower Counts (log scale)",
       x = "Follower Count (log10)", 
       y = "Number of Users",
       caption = "Note: Top 1% of users excluded for clarity")

print_section("TRACKS DATA EXPLORATION")

# Basic info
cat("Dimensions:", dim(tracks), "\n")
cat("Column names:", paste(names(tracks), collapse=", "), "\n\n")

# Track statistics
tracks %>% 
  summarise(
    total_tracks = n(),
    avg_duration = mean(duration_sec, na.rm = TRUE),
    median_duration = median(duration_sec, na.rm = TRUE),
    avg_play_count = mean(play_count, na.rm = TRUE),
    median_play_count = median(play_count, na.rm = TRUE),
    avg_like_count = mean(like_count, na.rm = TRUE),
    median_like_count = median(like_count, na.rm = TRUE)
  ) %>% 
  knitr::kable(digits = 2, caption = "Track Statistics Summary")

# Top 10 Primary Genres
tracks %>% 
  count(genre_primary, sort = TRUE) %>% 
  head(10) %>% 
  knitr::kable(caption = "Top 10 Primary Genres")

tracks %>% 
  filter(play_count > 0) %>% 
  ggplot(aes(x = play_count)) +
  geom_histogram(fill = "coral", bins = 50) +
  scale_x_log10() +
  labs(title = "Distribution of Track Play Counts (log scale)",
       x = "Play Count (log10)", 
       y = "Number of Tracks")

tracks %>% 
  filter(!is.na(genre_primary), genre_primary != "") %>% 
  count(genre_primary, sort = TRUE) %>% 
  head(20) %>% 
  ggplot(aes(x = reorder(genre_primary, n), y = n)) +
  geom_col(fill = "orange") +
  coord_flip() +
  labs(title = "Top 20 Primary Music Genres",
       x = "Genre", 
       y = "Number of Tracks")

print_section("FOLLOWS DATA EXPLORATION")

# Basic info
cat("Dimensions:", dim(follows), "\n")
cat("Column names:", paste(names(follows), collapse=", "), "\n\n")

# Follow network statistics
follows %>% 
  summarise(
    total_follows = n(),
    unique_followers = n_distinct(follower_id),
    unique_followed = n_distinct(followee_id)
  ) %>% 
  knitr::kable(caption = "Follow Network Statistics")

# Top followed users
follows %>% 
  count(followee_id, sort = TRUE) %>% 
  head(10) %>% 
  left_join(users, by = c("followee_id" = "user_id")) %>% 
  select(followee_id, username, n) %>% 
  knitr::kable(caption = "Top 10 Most Followed Users", col.names = c("User ID", "Username", "Follower Count"))

# Degree distribution in follow network
degree_dist <- follows %>% 
  count(follower_id, name = "out_degree") %>% 
  full_join(
    follows %>% count(followee_id, name = "in_degree"),
    by = c("follower_id" = "followee_id")
  ) %>% 
  replace_na(list(out_degree = 0, in_degree = 0))

degree_dist %>% 
  summarise(
    avg_out_degree = mean(out_degree),
    median_out_degree = median(out_degree),
    max_out_degree = max(out_degree),
    avg_in_degree = mean(in_degree, na.rm = TRUE),
    median_in_degree = median(in_degree, na.rm = TRUE),
    max_in_degree = max(in_degree, na.rm = TRUE)
  ) %>% 
  knitr::kable(digits = 2, caption = "Degree Distribution Summary")

print_section("ENGAGEMENTS DATA EXPLORATION")

# Basic info
cat("Dimensions:", dim(engagements), "\n")
cat("Column names:", paste(names(engagements), collapse=", "), "\n\n")

# Engagement type distribution
engagements %>% 
  count(engagement_type, sort = TRUE) %>% 
  mutate(percentage = n / sum(n) * 100) %>% 
  knitr::kable(digits = 2, caption = "Engagement Type Distribution")

# Engagement statistics
engagements %>% 
  summarise(
    total_engagements = n(),
    unique_users = n_distinct(user_id),
    unique_tracks = n_distinct(track_id),
    avg_engagements_per_user = n() / n_distinct(user_id)
  ) %>% 
  knitr::kable(digits = 2, caption = "Engagement Statistics")

engagements %>% 
  count(engagement_type) %>% 
  ggplot(aes(x = reorder(engagement_type, n), y = n)) +
  geom_col(fill = "darkgreen") +
  coord_flip() +
  labs(title = "Distribution of Engagement Types",
       x = "Engagement Type", 
       y = "Count") +
  scale_y_continuous(labels = scales::comma)

print_section("STREAMING EVENTS DATA EXPLORATION")

# Basic info
cat("Dimensions:", dim(streaming_events), "\n")
cat("Column names:", paste(names(streaming_events), collapse=", "), "\n\n")

# Streaming statistics
streaming_events %>% 
  summarise(
    total_events = n(),
    unique_users = n_distinct(user_id),
    unique_tracks = n_distinct(track_id),
    avg_duration = mean(duration_played_sec, na.rm = TRUE),
    median_duration = median(duration_played_sec, na.rm = TRUE),
    avg_completion_rate = mean(completion_rate, na.rm = TRUE)
  ) %>% 
  knitr::kable(digits = 2, caption = "Streaming Statistics")

# Source distribution
streaming_events %>% 
  count(source, sort = TRUE) %>% 
  mutate(percentage = n / sum(n) * 100) %>% 
  knitr::kable(digits = 2, caption = "Streaming Source Distribution")

streaming_events %>% 
  count(source) %>% 
  ggplot(aes(x = reorder(source, n), y = n)) +
  geom_col(fill = "navy") +
  coord_flip() +
  labs(title = "Streaming Source Distribution",
       x = "Source Type", 
       y = "Number of Streams") +
  scale_y_continuous(labels = scales::comma)

print_section("PLAYLISTS DATA EXPLORATION")

# Basic info
cat("Dimensions:", dim(playlists), "\n")
cat("Column names:", paste(names(playlists), collapse=", "), "\n\n")

# Playlist statistics
playlists %>% 
  mutate(track_count = str_count(track_ids, ",") + 1) %>%
  summarise(
    total_playlists = n(),
    unique_creators = n_distinct(creator_id),
    avg_track_count = mean(track_count, na.rm = TRUE),
    median_track_count = median(track_count, na.rm = TRUE),
    avg_follower_count = mean(follower_count, na.rm = TRUE),
    median_follower_count = median(follower_count, na.rm = TRUE)
  ) %>% 
  knitr::kable(digits = 2, caption = "Playlist Statistics")

# Create individual plots
p1 <- users %>% 
  filter(follower_count < quantile(follower_count, 0.99, na.rm = TRUE)) %>% 
  ggplot(aes(x = follower_count)) +
  geom_histogram(fill = "steelblue", bins = 50) +
  scale_x_log10() +
  labs(title = "Follower Distribution",
       x = "Follower Count (log10)", y = "Users") +
  theme_minimal()

p2 <- tracks %>% 
  filter(play_count > 0) %>% 
  ggplot(aes(x = play_count)) +
  geom_histogram(fill = "coral", bins = 50) +
  scale_x_log10() +
  labs(title = "Play Count Distribution",
       x = "Play Count (log10)", y = "Tracks") +
  theme_minimal()

p3 <- engagements %>% 
  count(engagement_type) %>% 
  ggplot(aes(x = reorder(engagement_type, n), y = n)) +
  geom_col(fill = "darkgreen") +
  coord_flip() +
  labs(title = "Engagement Types",
       x = "Type", y = "Count") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()

p4 <- users %>% 
  count(user_type, sort = TRUE) %>% 
  ggplot(aes(x = reorder(user_type, n), y = n)) +
  geom_col(fill = "purple") +
  coord_flip() +
  labs(title = "User Types",
       x = "Type", y = "Count") +
  theme_minimal()

# Combine plots
grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)
