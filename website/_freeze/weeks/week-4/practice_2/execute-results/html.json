{
  "hash": "e03d1af8e0f62c96cf95fe104212175b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Practice Exercise: QAP Regression\"\nsubtitle: \"Week 4 - Network Analytics\"\nformat:\n  html:\n    toc: true\n    code-fold: false\n---\n\n## Exercise Overview\n\nIn this exercise, we'll explore **QAP (Quadratic Assignment Procedure) Regression**, a method for testing relationships between network matrices while accounting for the dependency structure in network data. We'll examine:\n\n1. **QAP Correlation**: Testing association between two networks\n2. **QAP Regression**: Predicting one network from multiple others\n3. **Interpretation**: Understanding results and significance tests\n\n## Setup\n\nLoad required packages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sna)\nlibrary(network)\nset.seed(456)  # for reproducibility\n```\n:::\n\n\n## Part 1: Creating Example Networks\n\nLet's create a scenario with employees in a small company. We'll examine relationships between:\n- **Advice network**: Who seeks work advice from whom\n- **Friendship network**: Who considers whom a friend  \n- **Office proximity**: Physical distance between desks\n- **Department**: Same department membership\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create 10 employees\nn <- 10\nemployees <- paste0(\"Emp\", 1:10)\n\n# 1. Create advice network (who seeks advice from whom)\nadvice <- matrix(0, n, n)\nrownames(advice) <- colnames(advice) <- employees\n\n# Senior employees (1-3) give advice to juniors\nadvice[4:10, 1:3] <- rbinom(21, 1, 0.6)\n# Some peer advice among juniors\nadvice[4:7, 8:10] <- rbinom(12, 1, 0.3)\nadvice[8:10, 4:7] <- rbinom(12, 1, 0.3)\ndiag(advice) <- 0  # no self-loops\n\n# 2. Create friendship network (undirected)\nfriendship <- matrix(0, n, n)\nrownames(friendship) <- colnames(friendship) <- employees\n\n# Friends within similar levels\nfriendship[1:3, 1:3] <- rbinom(9, 1, 0.5)\nfriendship[4:7, 4:7] <- rbinom(16, 1, 0.4)\nfriendship[8:10, 8:10] <- rbinom(9, 1, 0.5)\n# Some cross-level friendships\nfriendship[1:3, 4:7] <- rbinom(12, 1, 0.2)\nfriendship[4:7, 1:3] <- t(friendship[1:3, 4:7])\n\n# Make symmetric and remove diagonal\nfriendship[lower.tri(friendship)] <- t(friendship)[lower.tri(friendship)]\ndiag(friendship) <- 0\n\n# 3. Create office proximity (based on desk distance)\n# Closer desks = higher values\noffice_dist <- matrix(0, n, n)\nrownames(office_dist) <- colnames(office_dist) <- employees\n\n# Create distance based on floor/section\nfor(i in 1:n) {\n  for(j in 1:n) {\n    if(i != j) {\n      # Same section (1-3, 4-7, 8-10)\n      if((i <= 3 & j <= 3) | \n         (i >= 4 & i <= 7 & j >= 4 & j <= 7) |\n         (i >= 8 & j >= 8)) {\n        office_dist[i,j] <- runif(1, 0.7, 1)  # close proximity\n      } else {\n        office_dist[i,j] <- runif(1, 0, 0.3)  # far proximity\n      }\n    }\n  }\n}\n\n# 4. Create department membership (same = 1, different = 0)\ndept <- c(rep(\"Sales\", 3), rep(\"Tech\", 4), rep(\"Admin\", 3))\nsame_dept <- matrix(0, n, n)\nfor(i in 1:n) {\n  for(j in 1:n) {\n    if(dept[i] == dept[j] & i != j) same_dept[i,j] <- 1\n  }\n}\nrownames(same_dept) <- colnames(same_dept) <- employees\n```\n:::\n\n\n## Part 2: Visualizing Networks\n\nLet's visualize our networks to understand their structure:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(2, 2))\n\n# Plot advice network\ngplot(advice, \n      vertex.col = c(rep(\"#c41c85\", 3), rep(\"#50C878\", 4), rep(\"#4169E1\", 3)),\n      vertex.cex = 2,\n      label = employees,\n      label.col = \"white\",\n      label.cex = 0.7,\n      edge.col = \"#D3D3D3\",\n      main = \"Advice Network\",\n      sub = \"(Pink: Senior, Green: Tech, Blue: Admin)\")\n\n# Plot friendship network  \ngplot(friendship,\n      vertex.col = c(rep(\"#c41c85\", 3), rep(\"#50C878\", 4), rep(\"#4169E1\", 3)),\n      vertex.cex = 2,\n      label = employees,\n      label.col = \"white\", \n      label.cex = 0.7,\n      edge.col = \"#D3D3D3\",\n      main = \"Friendship Network\",\n      mode = \"fruchtermanreingold\")\n\n# Plot office proximity\ngplot(office_dist,\n      vertex.col = c(rep(\"#c41c85\", 3), rep(\"#50C878\", 4), rep(\"#4169E1\", 3)),\n      vertex.cex = 2,\n      label = employees,\n      label.col = \"white\",\n      label.cex = 0.7,\n      edge.col = gray(1 - office_dist),\n      edge.lwd = office_dist * 3,\n      main = \"Office Proximity\",\n      sub = \"(Darker/thicker = closer desks)\")\n\n# Plot department membership\ngplot(same_dept,\n      vertex.col = c(rep(\"#c41c85\", 3), rep(\"#50C878\", 4), rep(\"#4169E1\", 3)),\n      vertex.cex = 2,\n      label = employees,\n      label.col = \"white\",\n      label.cex = 0.7,\n      edge.col = \"#D3D3D3\",\n      main = \"Same Department\")\n```\n\n::: {.cell-output-display}\n![](practice_2_files/figure-html/unnamed-chunk-3-1.png){width=1152}\n:::\n:::\n\n\n## Part 3: QAP Correlation\n\nTest pairwise correlations between networks using QAP:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Test correlation between advice and friendship\nqap_advice_friend <- qaptest(list(advice, friendship), \n                              gcor,\n                              g1 = 1, g2 = 2,\n                              reps = 1000)\n\ncat(\"QAP Correlation: Advice ~ Friendship\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nQAP Correlation: Advice ~ Friendship\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Observed correlation:\", round(qap_advice_friend$testval, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nObserved correlation: -0.12 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"P-value:\", round(qap_advice_friend$pgreq, 3), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP-value: 0.937 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Visualize QAP test\nhist(qap_advice_friend$dist, \n     breaks = 30,\n     main = \"QAP Test: Advice ~ Friendship\",\n     xlab = \"Correlation\",\n     col = \"lightgray\")\nabline(v = qap_advice_friend$testval, col = \"red\", lwd = 2)\ntext(qap_advice_friend$testval, max(table(cut(qap_advice_friend$dist, 30))), \n     \"Observed\", col = \"red\", pos = 4)\n```\n\n::: {.cell-output-display}\n![](practice_2_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n::: {.callout-tip}\n## Interpretation\nThe QAP test permutes one matrix while holding the other fixed, maintaining the dependency structure. If p < 0.05, the correlation is significant.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Test all pairwise correlations\nnetworks <- list(advice, friendship, office_dist, same_dept)\nnet_names <- c(\"Advice\", \"Friendship\", \"Office\", \"SameDept\")\n\n# Create correlation matrix\nqap_cors <- matrix(NA, 4, 4)\nqap_pvals <- matrix(NA, 4, 4)\n\nfor(i in 1:4) {\n  for(j in 1:4) {\n    if(i != j) {\n      qap_result <- qaptest(networks, gcor, g1 = i, g2 = j, reps = 500)\n      qap_cors[i,j] <- qap_result$testval\n      qap_pvals[i,j] <- qap_result$pgreq\n    }\n  }\n}\n\n# Display results\ncolnames(qap_cors) <- rownames(qap_cors) <- net_names\ncolnames(qap_pvals) <- rownames(qap_pvals) <- net_names\n\ncat(\"\\nQAP Correlation Matrix:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nQAP Correlation Matrix:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(round(qap_cors, 3))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           Advice Friendship Office SameDept\nAdvice         NA     -0.120 -0.346   -0.364\nFriendship -0.120         NA  0.132    0.157\nOffice     -0.346      0.132     NA    0.963\nSameDept   -0.364      0.157  0.963       NA\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nQAP P-values:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nQAP P-values:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(round(qap_pvals, 3))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           Advice Friendship Office SameDept\nAdvice         NA      0.936  1.000    1.000\nFriendship  0.940         NA  0.228    0.294\nOffice      0.998      0.226     NA    0.000\nSameDept    1.000      0.276  0.002       NA\n```\n\n\n:::\n:::\n\n\n## Part 4: QAP Regression\n\nNow let's predict advice-seeking from friendship, office proximity, and department:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prepare matrices for regression\ny <- advice\nX <- array(dim = c(3, n, n))\nX[1,,] <- friendship\nX[2,,] <- office_dist  \nX[3,,] <- same_dept\n\n# Run QAP regression with OLS\nqap_ols <- netlm(y, X, \n                 mode = \"digraph\",\n                 nullhyp = \"qap\",\n                 reps = 1000)\n\n# Display results\ncat(\"QAP Regression Results: Advice Network\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nQAP Regression Results: Advice Network\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"=====================================\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=====================================\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(qap_ols)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nOLS Network Model\n\nResiduals:\n         0%         25%         50%         75%        100% \n-0.38036458 -0.37118013 -0.02597158  0.61973275  0.70609565 \n\nCoefficients:\n            Estimate    Pr(<=b) Pr(>=b) Pr(>=|b|)\n(intercept)  0.36359484 0.998   0.002   0.002    \nx1          -0.07784050 0.269   0.731   0.520    \nx2           0.05628842 0.515   0.485   0.922    \nx3          -0.39280897 0.166   0.834   0.329    \n\nResidual standard error: 0.4204 on 86 degrees of freedom\nMultiple R-squared: 0.1364 \tAdjusted R-squared: 0.1063 \nF-statistic: 4.529 on 3 and 86 degrees of freedom, p-value: 0.005367 \n\n\nTest Diagnostics:\n\n\tNull Hypothesis: qap \n\tReplications: 1000 \n\tCoefficient Distribution Summary:\n\n       (intercept)        x1        x2        x3\nMin      -2.554932 -2.755432 -3.543105 -2.941607\n1stQ     -0.011421 -0.682755 -0.642629 -0.720567\nMedian    0.647864 -0.056711  0.062208 -0.026336\nMean      0.651294 -0.022526  0.035152  0.006521\n3rdQ      1.339457  0.629649  0.747231  0.724377\nMax       4.194518  3.752002  3.602831  4.011717\n```\n\n\n:::\n:::\n\n\n::: {.callout-note}\n## Understanding QAP Regression Output\n- **Coefficients**: Effect of each predictor on advice-seeking\n- **Std. Error**: Uncertainty in estimates\n- **P-values**: Significance based on QAP permutations\n- **R-squared**: Proportion of variance explained\n:::\n\n## Part 5: Visualizing Regression Results\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract coefficients and create bar plot\ncoef_names <- c(\"Intercept\", \"Friendship\", \"Office Proximity\", \"Same Dept\")\ncoef_vals <- qap_ols$coefficients\ncoef_pvals <- qap_ols$pgreqabs\n\n# Create coefficient plot\npar(mfrow = c(2, 1))\n\n# Coefficient values\nbarplot(coef_vals, \n        names.arg = coef_names,\n        col = ifelse(coef_pvals < 0.05, \"#c41c85\", \"gray\"),\n        main = \"QAP Regression Coefficients\",\n        ylab = \"Coefficient Value\",\n        las = 2)\nabline(h = 0, lty = 2)\nlegend(\"topright\", \n       legend = c(\"p < 0.05\", \"p â‰¥ 0.05\"),\n       fill = c(\"#c41c85\", \"gray\"))\n\n# P-values\nbarplot(-log10(coef_pvals), \n        names.arg = coef_names,\n        col = ifelse(coef_pvals < 0.05, \"#50C878\", \"lightgray\"),\n        main = \"Statistical Significance (-log10 p-value)\",\n        ylab = \"-log10(p-value)\",\n        las = 2)\nabline(h = -log10(0.05), lty = 2, col = \"red\")\ntext(4, -log10(0.05), \"p = 0.05\", col = \"red\", pos = 3)\n```\n\n::: {.cell-output-display}\n![](practice_2_files/figure-html/unnamed-chunk-7-1.png){width=960}\n:::\n:::\n\n\n## Part 6: Model Diagnostics\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate fitted values and residuals\nfitted_vals <- qap_ols$fitted.values\nresiduals <- qap_ols$residuals\n\n# Residual plots\npar(mfrow = c(1, 2))\n\n# Histogram of residuals\nhist(residuals, \n     breaks = 30,\n     main = \"Distribution of Residuals\",\n     xlab = \"Residuals\",\n     col = \"lightblue\")\n\n# Fitted vs residuals\nplot(fitted_vals, residuals,\n     main = \"Fitted vs Residuals\",\n     xlab = \"Fitted Values\",\n     ylab = \"Residuals\",\n     pch = 19,\n     col = rgb(0, 0, 0, 0.5))\nabline(h = 0, col = \"red\", lty = 2)\n```\n\n::: {.cell-output-display}\n![](practice_2_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Your Turn\n\nTry these exercises:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Exercise 1: Create and test a hypothesis\n# Do people seek advice more from those in their department who are also friends?\n# Hint: Create an interaction term\n\n# Your code here\n\n\n# Exercise 2: Reverse the analysis\n# Predict friendship from advice-seeking, proximity, and department\n\n# Your code here\n\n\n# Exercise 3: Add a new predictor\n# Create a \"seniority difference\" matrix and add it to the model\n\n# Your code here\n```\n:::\n\n\n## Key Concepts\n\n1. **QAP** preserves network structure during permutation tests\n2. **Network autocorrelation** makes standard tests invalid\n3. **Multiple regression** with QAP allows complex hypotheses\n4. **Effect sizes** matter as much as significance\n\n::: {.callout-warning}\n## Common Pitfalls\n- Don't use standard correlation/regression on network data\n- Check for multicollinearity between predictors\n- Consider directed vs undirected relationships\n- Remember that QAP is computationally intensive\n:::\n\n::: {.callout-note collapse=\"true\"}\n## Solutions to Exercises\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Exercise 1 Solution: Interaction term\ninteraction <- friendship * same_dept\nX_int <- array(dim = c(4, n, n))\nX_int[1,,] <- friendship\nX_int[2,,] <- office_dist\nX_int[3,,] <- same_dept\nX_int[4,,] <- interaction\n\nqap_interact <- netlm(y, X_int, mode = \"digraph\", \n                      nullhyp = \"qap\", reps = 500)\nsummary(qap_interact)\n\n# Exercise 2 Solution: Reverse prediction\ny_friend <- friendship\nX_friend <- array(dim = c(3, n, n))\nX_friend[1,,] <- advice\nX_friend[2,,] <- office_dist\nX_friend[3,,] <- same_dept\n\nqap_friend <- netlm(y_friend, X_friend, mode = \"graph\",\n                    nullhyp = \"qap\", reps = 500)\nsummary(qap_friend)\n\n# Exercise 3 Solution: Seniority difference\nseniority <- c(10, 9, 8, 5, 4, 3, 3, 2, 1, 1)  # years\nsen_diff <- matrix(0, n, n)\nfor(i in 1:n) {\n  for(j in 1:n) {\n    sen_diff[i,j] <- abs(seniority[i] - seniority[j])\n  }\n}\n\nX_sen <- array(dim = c(4, n, n))\nX_sen[1,,] <- friendship\nX_sen[2,,] <- office_dist  \nX_sen[3,,] <- same_dept\nX_sen[4,,] <- sen_diff\n\nqap_sen <- netlm(y, X_sen, mode = \"digraph\",\n                 nullhyp = \"qap\", reps = 500)\nsummary(qap_sen)\n```\n:::\n\n:::",
    "supporting": [
      "practice_2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}