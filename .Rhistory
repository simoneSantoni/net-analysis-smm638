# Load required libraries
library(tidyverse)
library(gridExtra)
library(knitr)

# Set theme for plots
theme_set(theme_minimal())

# Configure output options
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Disable httpgd
options(vsc.use_httpgd = FALSE)

# Set data path
data_path <- "../../../data/soundcloud/output/"

# Load all CSV files
users <- read_csv(paste0(data_path, "users.csv"), show_col_types = FALSE)
tracks <- read_csv(paste0(data_path, "tracks.csv"), show_col_types = FALSE)
follows <- read_csv(paste0(data_path, "follows.csv"), show_col_types = FALSE)
engagements <- read_csv(paste0(data_path, "engagements.csv"), show_col_types = FALSE)
streaming_events <- read_csv(paste0(data_path, "streaming_events.csv"), show_col_types = FALSE)
playlists <- read_csv(paste0(data_path, "playlists.csv"), show_col_types = FALSE)

cat("All datasets loaded successfully!\n")

cat("Dataset dimensions:", nrow(users), "rows,", ncol(users), "columns\n")
cat("Columns:", paste(names(users), collapse = ", "), "\n\n")

# Summary statistics
summary(users[, c("follower_count", "following_count", "track_count", "total_plays")])

# Check for missing values
missing_check <- colSums(is.na(users))
if (any(missing_check > 0)) {
  data.frame(
    column = names(missing_check)[missing_check > 0],
    missing_count = missing_check[missing_check > 0]
  ) %>%
    kable(caption = "Columns with missing values")
} else {
  cat("No missing values found in the users dataset.\n")
}

users %>% 
  summarise(
    `Total Users` = n(),
    `Avg Followers` = round(mean(follower_count), 2),
    `Median Followers` = median(follower_count),
    `Avg Following` = round(mean(following_count), 2),
    `Median Following` = median(following_count),
    `Avg Tracks` = round(mean(track_count), 2),
    `Median Tracks` = median(track_count)
  ) %>% 
  kable(caption = "User Statistics Summary")

users %>% 
  count(user_type, sort = TRUE) %>% 
  mutate(percentage = round(n / sum(n) * 100, 1)) %>%
  kable(caption = "User Type Distribution", col.names = c("User Type", "Count", "Percentage"))
